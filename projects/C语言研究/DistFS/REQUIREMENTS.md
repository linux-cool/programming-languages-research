# DistFS 需求规格说明书

## 1. 项目背景

### 1.1 项目目标
开发一个高性能、可扩展的分布式文件存储系统，用于展示C语言在大型系统开发中的应用能力，同时作为面试项目展示技术实力。

### 1.2 目标用户
- **主要用户**: 技术面试官、开源社区开发者
- **次要用户**: 学习系统编程的开发者、研究分布式系统的学者

### 1.3 应用场景
- 面试技术展示
- 开源项目贡献
- 技术学习和研究
- 小规模分布式存储需求

## 2. 功能需求

### 2.1 核心功能需求

#### FR-001: 文件基本操作
**描述**: 系统应支持基本的文件操作
**优先级**: 高
**详细需求**:
- 文件创建、读取、更新、删除(CRUD)
- 目录操作(创建、删除、列表)
- 文件属性查询(大小、修改时间、权限等)
- 文件重命名和移动

**验收标准**:
- 支持最大单文件大小: 1GB
- 支持最大文件名长度: 255字符
- 支持嵌套目录深度: 100层
- 操作响应时间: < 10ms (95%情况下)

#### FR-002: 分布式存储
**描述**: 系统应支持数据在多个节点间分布存储
**优先级**: 高
**详细需求**:
- 数据自动分片存储
- 支持数据副本机制(默认3副本)
- 一致性哈希算法实现负载均衡
- 支持节点动态加入和退出

**验收标准**:
- 支持最少3个存储节点
- 支持最多100个存储节点
- 数据分布均匀度: 方差 < 10%
- 节点加入/退出时数据迁移时间: < 5分钟

#### FR-003: 数据一致性
**描述**: 系统应保证分布式环境下的数据一致性
**优先级**: 高
**详细需求**:
- 强一致性读写保证
- 支持事务操作
- 冲突检测和解决机制
- 数据版本管理

**验收标准**:
- 读写一致性: 100%
- 事务成功率: > 99.9%
- 冲突解决时间: < 100ms
- 支持最大并发事务数: 1000

#### FR-004: 故障恢复
**描述**: 系统应具备故障检测和自动恢复能力
**优先级**: 高
**详细需求**:
- 节点健康检查机制
- 自动故障转移
- 数据修复和重建
- 集群状态监控

**验收标准**:
- 故障检测时间: < 30秒
- 故障转移时间: < 2分钟
- 数据修复成功率: > 99.9%
- 系统可用性: > 99.9%

### 2.2 扩展功能需求

#### FR-005: 权限管理
**描述**: 系统应支持用户权限管理
**优先级**: 中
**详细需求**:
- 用户认证机制
- 基于角色的访问控制(RBAC)
- 文件级权限控制
- 审计日志记录

#### FR-006: 数据压缩
**描述**: 系统应支持数据压缩以节省存储空间
**优先级**: 中
**详细需求**:
- 支持多种压缩算法(LZ4, ZSTD)
- 透明压缩和解压缩
- 压缩率统计
- 可配置压缩策略

#### FR-007: 数据加密
**描述**: 系统应支持数据加密保护
**优先级**: 中
**详细需求**:
- 传输加密(TLS)
- 存储加密(AES-256)
- 密钥管理
- 加密性能优化

#### FR-008: 监控告警
**描述**: 系统应提供完善的监控和告警功能
**优先级**: 中
**详细需求**:
- 性能指标监控
- 系统状态监控
- 告警规则配置
- 监控数据可视化

## 3. 非功能需求

### 3.1 性能需求

#### NFR-001: 吞吐量要求
- 单节点读取吞吐量: > 500 MB/s
- 单节点写入吞吐量: > 300 MB/s
- 集群总吞吐量: 线性扩展
- 小文件操作QPS: > 10,000

#### NFR-002: 延迟要求
- 平均读取延迟: < 5ms
- 平均写入延迟: < 10ms
- 99%读取延迟: < 50ms
- 99%写入延迟: < 100ms

#### NFR-003: 并发要求
- 支持并发连接数: > 10,000
- 支持并发操作数: > 1,000
- 线程池大小: 可配置(默认CPU核数*2)

### 3.2 可靠性需求

#### NFR-004: 可用性要求
- 系统可用性: 99.9% (年停机时间 < 8.76小时)
- 单点故障恢复时间: < 2分钟
- 数据持久性: 99.999999999% (11个9)

#### NFR-005: 容错要求
- 支持最多30%节点同时故障
- 网络分区容忍性
- 数据自动修复能力
- 优雅降级机制

### 3.3 可扩展性需求

#### NFR-006: 水平扩展
- 支持在线扩容和缩容
- 扩容时数据自动重平衡
- 扩容对服务影响: < 5%性能下降

#### NFR-007: 存储容量
- 单集群支持容量: > 100TB
- 单节点支持容量: > 10TB
- 文件数量限制: > 10亿个文件

### 3.4 可维护性需求

#### NFR-008: 运维友好
- 配置热重载
- 在线升级支持
- 详细的运行日志
- 性能指标导出

#### NFR-009: 开发友好
- 模块化设计
- 清晰的API接口
- 完整的文档
- 丰富的测试用例

## 4. 技术需求

### 4.1 开发环境要求
- **操作系统**: Linux (Ubuntu 20.04+, CentOS 8+)
- **编译器**: GCC 9.0+ 或 Clang 10.0+
- **构建工具**: CMake 3.20+
- **版本控制**: Git 2.25+

### 4.2 运行环境要求
- **最小硬件配置**:
  - CPU: 2核心
  - 内存: 4GB
  - 存储: 100GB
  - 网络: 1Gbps

- **推荐硬件配置**:
  - CPU: 8核心
  - 内存: 32GB
  - 存储: 1TB SSD
  - 网络: 10Gbps

### 4.3 依赖库要求
- **必需依赖**:
  - libc (glibc 2.31+)
  - pthread
  - libssl (OpenSSL 1.1.1+)

- **可选依赖**:
  - liblz4 (压缩支持)
  - libzstd (压缩支持)
  - libjemalloc (内存分配优化)

## 5. 接口需求

### 5.1 客户端API接口

#### 5.1.1 文件操作接口
```c
// 文件创建
int distfs_create(const char *path, mode_t mode);

// 文件打开
int distfs_open(const char *path, int flags);

// 文件读取
ssize_t distfs_read(int fd, void *buf, size_t count);

// 文件写入
ssize_t distfs_write(int fd, const void *buf, size_t count);

// 文件关闭
int distfs_close(int fd);

// 文件删除
int distfs_unlink(const char *path);
```

#### 5.1.2 目录操作接口
```c
// 目录创建
int distfs_mkdir(const char *path, mode_t mode);

// 目录删除
int distfs_rmdir(const char *path);

// 目录列表
int distfs_readdir(const char *path, struct dirent **entries, int *count);
```

#### 5.1.3 元数据接口
```c
// 获取文件状态
int distfs_stat(const char *path, struct stat *buf);

// 修改文件权限
int distfs_chmod(const char *path, mode_t mode);

// 修改文件所有者
int distfs_chown(const char *path, uid_t owner, gid_t group);
```

### 5.2 管理接口

#### 5.2.1 集群管理接口
```c
// 添加节点
int distfs_add_node(const char *node_addr);

// 移除节点
int distfs_remove_node(const char *node_addr);

// 获取集群状态
int distfs_cluster_status(cluster_status_t *status);
```

#### 5.2.2 监控接口
```c
// 获取性能统计
int distfs_get_stats(distfs_stats_t *stats);

// 获取节点信息
int distfs_get_node_info(const char *node_addr, node_info_t *info);
```

### 5.3 网络协议接口

#### 5.3.1 客户端-服务器协议
- **传输协议**: TCP
- **应用协议**: 自定义二进制协议
- **消息格式**: Header(16字节) + Payload(变长)
- **压缩支持**: 可选LZ4压缩

#### 5.3.2 服务器间协议
- **传输协议**: TCP
- **应用协议**: 自定义二进制协议
- **心跳机制**: 每30秒发送心跳
- **数据同步**: 基于版本号的增量同步

## 6. 数据需求

### 6.1 数据模型

#### 6.1.1 文件元数据
```c
typedef struct {
    uint64_t inode;           // 文件inode号
    char name[256];           // 文件名
    uint64_t size;            // 文件大小
    uint32_t mode;            // 文件权限
    uint32_t uid;             // 所有者ID
    uint32_t gid;             // 组ID
    uint64_t atime;           // 访问时间
    uint64_t mtime;           // 修改时间
    uint64_t ctime;           // 创建时间
    uint32_t nlinks;          // 硬链接数
    uint64_t blocks[16];      // 数据块地址
} file_metadata_t;
```

#### 6.1.2 数据块结构
```c
typedef struct {
    uint64_t block_id;        // 块ID
    uint32_t size;            // 块大小
    uint32_t checksum;        // 校验和
    uint8_t replica_count;    // 副本数
    uint64_t replica_nodes[3]; // 副本节点
    uint8_t data[];           // 数据内容
} data_block_t;
```

### 6.2 存储格式

#### 6.2.1 磁盘布局
```
+------------------+
|   Super Block    |  (4KB)
+------------------+
|   Inode Table    |  (可变)
+------------------+
|   Data Blocks    |  (可变)
+------------------+
|   Free Space     |  (可变)
+------------------+
```

#### 6.2.2 索引结构
- **B+树索引**: 用于文件名到inode的映射
- **位图索引**: 用于空闲块管理
- **哈希索引**: 用于快速查找

## 7. 安全需求

### 7.1 认证授权
- 支持基于Token的认证
- 支持基于角色的访问控制
- 支持细粒度权限管理
- 支持审计日志记录

### 7.2 数据保护
- 传输数据加密(TLS 1.3)
- 存储数据加密(AES-256)
- 数据完整性校验(SHA-256)
- 密钥安全管理

### 7.3 网络安全
- 防止DDoS攻击
- 连接频率限制
- IP白名单机制
- 安全协议版本控制

## 8. 测试需求

### 8.1 功能测试
- 单元测试覆盖率 > 80%
- 集成测试覆盖所有模块
- 系统测试覆盖所有功能
- 回归测试自动化

### 8.2 性能测试
- 基准测试(Benchmark)
- 压力测试(Stress Test)
- 负载测试(Load Test)
- 容量测试(Volume Test)

### 8.3 可靠性测试
- 故障注入测试
- 混沌工程测试
- 长时间稳定性测试
- 数据一致性测试

### 8.4 安全测试
- 渗透测试
- 漏洞扫描
- 权限测试
- 加密强度测试

## 9. 部署需求

### 9.1 部署方式
- 支持单机部署(开发测试)
- 支持集群部署(生产环境)
- 支持容器化部署(Docker)
- 支持自动化部署(脚本)

### 9.2 配置管理
- 配置文件格式: YAML
- 支持环境变量覆盖
- 支持配置热重载
- 配置验证机制

### 9.3 监控运维
- 系统指标监控
- 应用指标监控
- 日志聚合分析
- 告警通知机制

## 10. 文档需求

### 10.1 用户文档
- 快速开始指南
- API参考文档
- 配置参考文档
- 故障排除指南

### 10.2 开发文档
- 架构设计文档
- 代码规范文档
- 贡献者指南
- 发布流程文档

### 10.3 运维文档
- 部署指南
- 运维手册
- 性能调优指南
- 备份恢复指南

## 11. 验收标准

### 11.1 功能验收
- [ ] 所有核心功能正常工作
- [ ] 所有扩展功能按需实现
- [ ] API接口完整可用
- [ ] 错误处理机制完善

### 11.2 性能验收
- [ ] 性能指标达到要求
- [ ] 压力测试通过
- [ ] 内存使用合理
- [ ] CPU使用率正常

### 11.3 质量验收
- [ ] 代码覆盖率达标
- [ ] 静态分析通过
- [ ] 内存泄漏检查通过
- [ ] 文档完整性达标

### 11.4 部署验收
- [ ] 部署脚本可用
- [ ] 配置文件完整
- [ ] 监控系统正常
- [ ] 日志输出正确